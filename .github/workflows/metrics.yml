name: GitHub Metrics
on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          committer_token: ${{ secrets.GITHUB_TOKEN }}
          user: Bashmak-1 
          template: classic
          filename: metrics-lecoq.svg
          config_timezone: Europe/Kyiv
          base: header

          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year

          plugin_habits: yes
          plugin_habits_facts: yes
          plugin_habits_from: 365

          plugin_languages: yes
          plugin_languages_sections: most-used
          plugin_languages_indepth: yes
          plugin_languages_limit: 10
          plugin_languages_details: lines, bytes-size, percentage
          plugin_languages_analysis_timeout: 60
          repositories_forks: true
          repositories_affiliations: owner,collaborator,organization_member
          repositories_skipped: Bashmak-1/Bashmak-1
          repositories_batch: 100

      - name: Bust README cache
        run: |
          FILE=README.md
          TS="${{ github.run_id }}"
          if grep -q "metrics-lecoq.svg?v=" "$FILE"; then
            sed -i -E "s#(metrics-lecoq\.svg\?v=)[0-9]+#\1${TS}#g" "$FILE"
          else
            sed -i -E "s#metrics-lecoq\.svg#metrics-lecoq.svg?v=${TS}#g" "$FILE"
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # üí° –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø:
          
          # 1. "–°—Ö–æ–≤–∞—î–º–æ" –Ω–∞—à—ñ –∑–º—ñ–Ω–∏ (–∑–º—ñ–Ω–µ–Ω–∏–π README.md) —É —Ç–∏–º—á–∞—Å–æ–≤–µ —Å—Ö–æ–≤–∏—â–µ
          git stash push -- "$FILE"
          
          # 2. –¢–µ–ø–µ—Ä –±–µ–∑–ø–µ—á–Ω–æ "–ø—ñ–¥—Ç—è–≥–Ω–µ–º–æ" –∑–º—ñ–Ω–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞ (—è–∫—â–æ –≤–æ–Ω–∏ —î)
          git pull --rebase
          
          # 3. –ü–æ–≤–µ—Ä–Ω–µ–º–æ –Ω–∞—à—ñ –∑–º—ñ–Ω–∏ –∑ —Ç–∏–º—á–∞—Å–æ–≤–æ–≥–æ —Å—Ö–æ–≤–∏—â–∞
          git stash pop
          
          # 4. –¢–µ–ø–µ—Ä –¥–æ–¥–∞—î–º–æ, –∫–æ–º—ñ—Ç–∏–º–æ —ñ –ø—É—à–∏–º–æ —è–∫ –∑–∞–∑–≤–∏—á–∞–π
          git add "$FILE"
          git commit -m "Bump README cache-buster to $TS [skip ci]" || echo "No README changes"
          git push